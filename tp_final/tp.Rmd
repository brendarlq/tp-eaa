---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code.

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*.

```{r}
install.packages("openxlsx")
# Instalar el paquete si no está instalado
if (!require("dplyr")) install.packages("dplyr")
# Cargar el paquete
library(dplyr)
```

# Trabajo Práctico Final

# 1) Fuente de datos

## Carga el dataset

.

```{r}
library(openxlsx)
delitos <- read.xlsx("/Users/bquinonez/Downloads/delitos_2023.xlsx")
delitos
```

```{r}
summary(delitos)

```

```{r}
dim(delitos)
```

# 2) Preprocesamiento

## Verificación de nulos

```{r}
colSums(is.na(delitos))
```

Tipos de Delitos

```{r}
cantidad_valores_unicos <- (unique(delitos$tipo))
print(cantidad_valores_unicos)
```

Subtipos de delitos

```{r}
conteo_por_tipo <- table(delitos$tipo)
print(conteo_por_tipo)
```

```{r}
cantidad_valores_unicos <- (unique(delitos$subtipo))
print(cantidad_valores_unicos)
conteo_por_subtipo <- table(delitos$subtipo)
print(conteo_por_subtipo)
```

## Creación de variables

Agregamos la columna de franja horaria

```{r}
#Genero la columna franja(horaria)
delitos <- delitos %>%
  mutate(
    franja_horaria = case_when(
      franja >= 6 & franja < 12 ~ "Mañana",
      franja >= 12 & franja < 18 ~ "Tarde",
      franja >= 18 & franja < 24 ~ "Noche",
      franja >= 0 & franja < 6  ~ "Madrugada",
      TRUE ~ "Desconocido" # Para casos fuera de rango 
    )
  )
delitos
```

Agregamos una columna que indica si es fin de semana o día de semana

```{r}
delitos$tipo_dia <- ifelse(delitos$dia %in% c("SAB", "DOM"),
                                             "Fin de semana", "Día de semana")
delitos
```

Agregamos una columna que indica la estación del año

```{r}
# Crear columna 'estacion' basada en el mes
delitos <- delitos %>%
  mutate(
    estacion = case_when(
      mes %in% c("diciembre", "enero", "febrero") ~ "Verano",
      mes %in% c("marzo", "abril", "mayo")       ~ "Otoño",
      mes %in% c("junio", "julio", "agosto")     ~ "Invierno",
      mes %in% c("septiembre", "octubre", "noviembre") ~ "Primavera",
      TRUE ~ "Desconocido" # Para casos no esperados
    )
  )
delitos
```

## Transformación de variables categóricas

Transformamos todos los caracteres a numéricos

```{r}

# Convertir todas las variables categóricas (character o factor) a numéricas
delitos <- delitos %>%
  mutate(across(
    .cols = where(is.character) & !all_of(c("longitud", "latitud")), 
    .fns = ~ as.numeric(as.factor(.))
  )) %>%
  mutate(across(
    .cols = where(is.factor) & !all_of(c("longitud", "latitud")), 
    .fns = ~ as.numeric(.)
  ))

# Verificar la estructura después de la conversión
delitos

```

Conversión de coordenas a númericas

```{r}
# Convertir longitud y latitud a numéricas y escalarlas correctamente
delitos <- delitos %>%
  mutate(
    longitud = as.numeric(longitud) / 1e6,  # Escalar dividiendo entre 10^6
    latitud = as.numeric(latitud) / 1e6    # Escalar dividiendo entre 10^6
  )

# Verificar las primeras filas para confirmar
head(delitos[c("longitud", "latitud")])
```

Eliminación de Nulos (Pero tiene que ser transformación de nulos para no perder datos, lo hacemos después)

```{r}
delitos <- na.omit(delitos)
dim(delitos)
```

# 3) Aplicación de FDA

## Hacemos la agrupación correspondiente por las variables que vamos a usar.
```{r}
# Instalar las librerías necesarias
if (!require("refund")) install.packages("refund")
# Cargar las librerías
library(refund)

# Preparar el dataset
# Agrupar por fecha y calcular la frecuencia diaria de delitos
delitos_agrupados <- delitos %>%
  group_by(fecha) %>%
  summarise(
    frecuencia_delitos = sum(cantidad),  # Nueva variable respuesta
    tipo_promedio = mean(tipo, na.rm = TRUE),  # Promedio de tipo por día
    franja_horaria_promedio = mean(franja_horaria, na.rm = TRUE)  # Promedio de franja horaria
  )

# Eliminar filas con valores faltantes
delitos_agrupados <- delitos_agrupados[complete.cases(delitos_agrupados), ]

```

## Creamos la variable indendiente y las matrices correspondientes

```{r}
# Crear la respuesta (frecuencia de delitos por día)
Y <- delitos_agrupados$frecuencia_delitos

# Crear una matriz funcional para 'tipo'
n_puntos <- 10  # Número de puntos funcionales
tipo_matrix <- matrix(rep(delitos_agrupados$tipo_promedio, each = n_puntos), 
                      nrow = nrow(delitos_agrupados), 
                      ncol = n_puntos)

# Crear una matriz funcional para 'franja_horaria'
franja_horaria_matrix <- matrix(rep(delitos_agrupados$franja_horaria_promedio, each = n_puntos), 
                                nrow = nrow(delitos_agrupados), 
                                ncol = n_puntos)

# Verificar dimensiones
print(length(Y))  # Longitud de Y
print(dim(tipo_matrix))  # Dimensiones de tipo_matrix
print(dim(franja_horaria_matrix))  # Dimensiones de franja_horaria_matrix

```

## Creamos el modelo con tipo de delito

```{r}
# Ajustar el modelo funcional con 'tipo' como predictora funcional
modelo_refund_tipo <- pfr(
  Y ~ lf(tipo_matrix, bs = "ps"),  # lf() para predictoras funcionales
  data = delitos_agrupados
)

# Resumen del modelo
summary(modelo_refund_tipo)

# Visualizar el efecto funcional
plot(modelo_refund_tipo, main = "Efecto Funcional de Tipo de Delito", 
     xlab = "Dominio (Puntos Funcionales)", ylab = "Efecto")



```
# Creamos el modelo mixto con tipo y franja horaria

```{r}
# Ajustar un modelo funcional con múltiples predictoras funcionales
modelo_refund_mixto <- pfr(
  Y ~ lf(tipo_matrix, bs = "ps") + lf(franja_horaria_matrix, bs = "ps"),
  data = delitos_agrupados
)

# Resumen del modelo mixto
summary(modelo_refund_mixto)

# Visualizar los efectos funcionales de las predictoras
plot(modelo_refund_mixto, main = "Efectos Funcionales de las Predictoras", pages = 1)


```


# Calculamos las métricas de la predicción
```{r}
# Generar predicciones del modelo mixto
# Predicciones del modelo
predicciones <- predict(modelo_refund_mixto)

# Valores reales (frecuencia de delitos)
valores_reales <- Y

# Calcular MAE
mae <- mean(abs(valores_reales - predicciones))

# Calcular MSE
mse <- mean((valores_reales - predicciones)^2)

# Calcular RMSE
rmse <- sqrt(mse)

# Calcular R^2
sse <- sum((valores_reales - predicciones)^2)  # Suma de errores al cuadrado
sst <- sum((valores_reales - mean(valores_reales))^2)  # Suma total de cuadrados
r2 <- 1 - (sse / sst)

# Mostrar las métricas
cat("MAE:", mae, "\n")
cat("MSE:", mse, "\n")
cat("RMSE:", rmse, "\n")
cat("R^2:", r2, "\n")

# Graficar predicciones vs valores reales
plot(Y, predicciones, main = "Predicciones vs Valores Reales (Modelo Mixto)",
     xlab = "Valores Reales", ylab = "Predicciones", col = "blue")
abline(0, 1, col = "red")

```


